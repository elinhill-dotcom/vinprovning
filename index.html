<!doctype html>
<html lang="sv" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <title>Vinprovning p√• slalomgr√§nd</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&amp;family=Lato:wght@300;400;500&amp;display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      width: 100%;
    }

    .font-display { font-family: 'Playfair Display', Georgia, serif; }
    .font-body { font-family: 'Lato', system-ui, sans-serif; }

    .wine-gradient {
      background: linear-gradient(135deg, #8b1e3f 0%, #4a0f25 100%);
    }

    .card-light {
      background: #f4efe7;
    }

    .accent-deep {
      color: #8b1e3f;
    }

    .accent-light {
      color: #f4efe7;
    }

    .wine-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 4px solid #8b1e3f;
      -webkit-tap-highlight-color: transparent;
    }

    .wine-card:active {
      transform: scale(0.98);
    }

    .wine-card.active {
      background: #fff5f0;
      border-left: 4px solid #f4efe7;
    }

    .btn-primary {
      background: #8b1e3f;
      color: #f4efe7;
      -webkit-tap-highlight-color: transparent;
      min-height: 48px;
      font-size: 16px;
    }

    .btn-primary:active {
      background: #6a1630;
    }

    .option-btn {
      border: 2px solid #ddd;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      min-height: 48px;
      font-size: 16px;
      font-weight: 500;
      padding: 12px 8px;
      touch-action: manipulation;
    }

    .option-btn:active {
      transform: scale(0.95);
    }

    .option-btn.selected {
      background: #8b1e3f;
      color: #f4efe7;
      border-color: #8b1e3f;
    }

    .quiz-option-btn {
      border: 2px solid #ddd;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      min-height: 48px;
      font-size: 15px;
      font-weight: 500;
      padding: 12px;
      touch-action: manipulation;
      cursor: pointer;
    }

    .quiz-option-btn:active {
      transform: scale(0.98);
    }

    .quiz-option-btn.selected {
      background: #8b1e3f;
      color: #f4efe7;
      border-color: #8b1e3f;
    }

    .quiz-option-btn.correct {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .quiz-option-btn.incorrect {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }

    .star-btn {
      -webkit-tap-highlight-color: transparent;
      min-width: 48px;
      min-height: 48px;
      font-size: 32px;
      padding: 4px;
      touch-action: manipulation;
    }

    .star-btn:active {
      transform: scale(1.1);
    }

    .star-rating {
      color: #8b1e3f;
    }

    input, textarea, select {
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
      border-radius: 8px;
    }

    input[type="text"], textarea, select {
      padding: 14px 16px;
      min-height: 48px;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b1e3f' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .result-card {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .result-card:active {
      transform: scale(0.98);
    }

    @keyframes slalom {
      0% { transform: translateX(-25px) rotateZ(-20deg); }
      25% { transform: translateX(20px) rotateZ(20deg); }
      50% { transform: translateX(-20px) rotateZ(-20deg); }
      75% { transform: translateX(25px) rotateZ(20deg); }
      100% { transform: translateX(-25px) rotateZ(-20deg); }
    }

    .slalom-bottle {
      animation: slalom 3.5s ease-in-out infinite;
      transform-origin: center;
    }

    @keyframes podium-rise {
      0% { transform: scaleY(0); opacity: 0; }
      100% { transform: scaleY(1); opacity: 1; }
    }

    .podium-gold {
      animation: podium-rise 0.6s ease-out 0.2s both;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      transform-origin: bottom;
    }

    .podium-silver {
      animation: podium-rise 0.6s ease-out 0.4s both;
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      transform-origin: bottom;
    }

    .podium-bronze {
      animation: podium-rise 0.6s ease-out 0.6s both;
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      transform-origin: bottom;
    }

    .podium-position {
      color: white;
      font-weight: bold;
      font-size: 24px;
    }

    @media (max-width: 640px) {
      .max-w-6xl {
        max-width: 100%;
      }

      .p-8 {
        padding: 16px;
      }

      .p-4 {
        padding: 12px;
      }

      .gap-4 {
        gap: 12px;
      }

      .grid {
        gap: 12px;
      }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.4s ease-out;
    }

    .reset-confirm {
      background: #dc2626;
    }

    .reset-confirm:hover {
      background: #991b1b;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full font-body">
  <div id="app" class="h-full w-full wine-gradient overflow-auto">
   <div class="w-full min-h-full p-4 pb-20"><!-- Header -->
    <header class="text-center mb-6">
     <div class="flex items-center justify-center gap-3 mb-3 flex-wrap">
      <svg width="70" height="70" viewbox="0 0 120 140" xmlns="http://www.w3.org/2000/svg" class="slalom-bottle flex-shrink-0"><g>
        <rect x="5" y="88" width="35" height="3" fill="#dd0000" rx="1" />
        <rect x="6" y="91" width="33" height="2" fill="#222" />
        <rect x="18" y="85" width="10" height="8" fill="#333" opacity="0.6" />
        <circle cx="20" cy="89" r="1.5" fill="#999" />
        <circle cx="26" cy="89" r="1.5" fill="#999" />
       </g> <g>
        <rect x="80" y="88" width="35" height="3" fill="#dd0000" rx="1" />
        <rect x="81" y="91" width="33" height="2" fill="#222" />
        <rect x="92" y="85" width="10" height="8" fill="#333" opacity="0.6" />
        <circle cx="94" cy="89" r="1.5" fill="#999" />
        <circle cx="100" cy="89" r="1.5" fill="#999" />
       </g> <rect x="57" y="15" width="6" height="12" fill="#1a3d0a" /> <rect x="56" y="10" width="8" height="4" fill="#d4af37" rx="1" /> <ellipse cx="60" cy="10" rx="4" ry="2" fill="#ffd700" /> <ellipse cx="60" cy="32" rx="13" ry="14" fill="#2d5016" /> <rect x="51" y="42" width="18" height="38" fill="#1a3d0a" rx="2" /> <rect x="52" y="48" width="16" height="28" fill="#722f37" rx="1" /> <ellipse cx="54" cy="38" rx="3" ry="8" fill="rgba(255,255,255,0.3)" />
      </svg>
      <h1 id="event-title" class="font-display text-2xl sm:text-4xl font-bold accent-light">Vinprovning p√• slalomgr√§nd</h1>
     </div>
     <p class="accent-light text-base opacity-90">Hitta √•rets b√§sta vin</p>
    </header>
    <div class="w-full"><!-- Navigation -->
     <div class="flex justify-center gap-2 mb-6 flex-wrap"><button id="btn-setup" onclick="showSetup()" class="px-4 py-2 sm:px-6 sm:py-2 rounded-full btn-primary transition-all text-sm sm:text-base"> ‚öôÔ∏è Inst. </button> <button id="btn-vote" onclick="showVoting()" class="px-4 py-2 sm:px-6 sm:py-2 rounded-full bg-white/20 accent-light transition-all text-sm sm:text-base"> üó≥Ô∏è R√∂sta </button> <button id="btn-wine-results" onclick="showWineResults()" class="px-4 py-2 sm:px-6 sm:py-2 rounded-full bg-white/20 accent-light transition-all text-sm sm:text-base"> üç∑ Resultat </button> <button id="btn-quiz" onclick="showQuiz()" class="px-4 py-2 sm:px-6 sm:py-2 rounded-full bg-white/20 accent-light transition-all text-sm sm:text-base"> üß† Quiz </button> <button id="btn-quiz-results" onclick="showQuizResults()" class="px-4 py-2 sm:px-6 sm:py-2 rounded-full bg-white/20 accent-light transition-all text-sm sm:text-base"> üèÜ Topplista </button>
     </div><!-- Setup Section -->
     <div id="setup-section" class="card-light rounded-xl shadow-xl p-4 sm:p-6 slide-in">
      <h2 class="font-display text-2xl font-bold accent-deep mb-4">L√§gg till viner</h2>
      <form id="wine-form" onsubmit="handleAddWine(event)">
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
        <div><label class="block text-xs font-semibold accent-deep mb-2">Vinnummer *</label> <input type="text" id="wine_number" required placeholder="t.ex. 1, A2, R√∂d" class="w-full rounded-lg border border-gray-300">
        </div>
        <div><label class="block text-xs font-semibold accent-deep mb-2">Land *</label> <input type="text" id="country" required placeholder="Frankrike" class="w-full rounded-lg border border-gray-300">
        </div>
        <div><label class="block text-xs font-semibold accent-deep mb-2">Druva *</label> <input type="text" id="grape" required placeholder="Pinot Noir" class="w-full rounded-lg border border-gray-300">
        </div>
        <div><label class="block text-xs font-semibold accent-deep mb-2">Pris</label> <input type="text" id="price" placeholder="250 kr" class="w-full rounded-lg border border-gray-300">
        </div>
       </div><button type="submit" class="w-full btn-primary rounded-lg font-semibold transition-all"> ‚ûï L√§gg till vin </button>
      </form>
      <div class="mt-6">
       <h3 class="font-display text-lg font-bold accent-deep mb-3">Registrerade viner</h3>
       <div id="wines-list" class="space-y-2"><!-- Wines will be listed here -->
       </div>
      </div>
      <hr class="my-6 border-gray-300">
      <div>
       <h3 class="font-display text-lg font-bold accent-deep mb-4">Deltagare</h3>
       <form id="participant-form" onsubmit="handleAddParticipant(event)">
        <div class="flex gap-2 mb-4"><input type="text" id="participant_name" required placeholder="Namn" class="flex-1 rounded-lg border border-gray-300"> <button type="submit" class="btn-primary px-4 py-3 sm:px-6 rounded-lg font-semibold transition-all min-h-[48px]"> ‚ûï </button>
        </div>
       </form>
       <div id="participants-list" class="grid grid-cols-2 sm:grid-cols-3 gap-2"><!-- Participants will be listed here -->
       </div>
      </div>
      <hr class="my-6 border-gray-300">
      <div>
       <h3 class="font-display text-lg font-bold accent-deep mb-4">√Öterst√§ll</h3><button id="reset-quiz-btn" onclick="confirmResetQuiz()" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-semibold transition-all min-h-[48px]"> üîÑ √Öterst√§ll Quiz </button>
       <p class="text-xs text-gray-600 mt-2">Tar bort alla quizresultat</p>
      </div>
     </div><!-- Voting Section -->
     <div id="voting-section" class="hidden slide-in">
      <div class="card-light rounded-xl shadow-xl p-4 sm:p-6 mb-4">
       <div class="mb-4"><label class="block text-xs font-semibold accent-deep mb-2">V√§lj deltagare *</label> <select id="voter-select" onchange="selectVoter()" class="w-full rounded-lg border border-gray-300"> <option value="">-- V√§lj deltagare --</option> </select>
       </div>
       <div id="wines-voting" class="space-y-3"><!-- Wine voting cards will be listed here -->
       </div>
      </div>
     </div><!-- Wine Results Section -->
     <div id="wine-results-section" class="hidden slide-in">
      <div class="card-light rounded-xl shadow-xl p-4 sm:p-6">
       <h2 class="font-display text-3xl font-bold accent-deep mb-6 text-center">üç∑ Vinprovning - Resultat</h2>
       <div id="wine-results-content" class="space-y-4"><!-- Wine results will be displayed here -->
       </div>
      </div>
     </div><!-- Quiz Section -->
     <div id="quiz-section" class="hidden slide-in">
      <div class="card-light rounded-xl shadow-xl p-4 sm:p-6 mb-4">
       <div id="quiz-start-screen">
        <h2 class="font-display text-2xl font-bold accent-deep mb-4">üß† Vinkunnighetens Quiz</h2>
        <p class="text-gray-600 mb-4">V√§lj ditt namn och testa din vinkompetens!</p><label class="block text-xs font-semibold accent-deep mb-2">V√§lj deltagare *</label> <select id="quiz-participant-select" class="w-full rounded-lg border border-gray-300 mb-4"> <option value="">-- V√§lj ditt namn --</option> </select> <button onclick="startQuiz()" class="w-full btn-primary rounded-lg font-semibold transition-all"> B√∂rja Quiz </button>
       </div>
       <div id="quiz-questions-screen" class="hidden">
        <div class="mb-4">
         <p class="font-semibold accent-deep text-center mb-3 text-lg" id="quiz-participant-name"></p>
         <div class="flex justify-between items-center mb-2">
          <p class="font-semibold accent-deep" id="quiz-question-number">Fr√•ga 1 av 15</p>
          <div class="bg-white px-3 py-1 rounded-full text-sm font-semibold accent-deep"><span id="quiz-score">0</span>/15
          </div>
         </div>
         <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="quiz-progress-bar" class="bg-8b1e3f h-2 rounded-full transition-all" style="width: 0%; background-color: #8b1e3f;"></div>
         </div>
        </div>
        <div id="quiz-question-container" class="space-y-4"><!-- Questions will be rendered here -->
        </div>
       </div>
      </div>
     </div><!-- Quiz Results Section -->
     <div id="quiz-results-section" class="hidden slide-in">
      <div class="card-light rounded-xl shadow-xl p-4 sm:p-6">
       <h2 class="font-display text-3xl font-bold accent-deep mb-6 text-center">üèÜ Quiz - Topplista</h2>
       <div id="quiz-results-content" class="space-y-4"><!-- Quiz results will be displayed here -->
       </div>
       <div id="quiz-detail-modal" class="hidden fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
        <div class="card-light rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-2xl max-h-[90vh] overflow-y-auto p-4 sm:p-8">
         <div class="flex justify-between items-start mb-6">
          <h3 id="quiz-detail-title" class="font-display text-2xl font-bold accent-deep">Quiz svar</h3><button type="button" onclick="closeQuizDetailModal()" class="text-2xl">‚úï</button>
         </div>
         <div id="quiz-detail-answers" class="space-y-4"><!-- Answers will be displayed here -->
         </div><button type="button" onclick="closeQuizDetailModal()" class="w-full btn-primary rounded-lg font-semibold transition-all mt-6"> ‚úï St√§ng </button>
        </div>
       </div>
      </div>
     </div><!-- Wine Rating Modal -->
     <div id="rating-modal" class="hidden fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
      <div class="card-light rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-2xl max-h-[90vh] overflow-y-auto p-4 sm:p-8">
       <h2 id="modal-wine-title" class="font-display text-2xl font-bold accent-deep mb-1">Vin</h2>
       <p id="modal-wine-info" class="text-gray-600 mb-6 text-sm"></p>
       <form id="rating-form" onsubmit="handleSubmitRating(event)">
        <div class="space-y-4">
         <div><label class="block text-sm font-semibold accent-deep mb-2">Aroma</label>
          <div class="flex gap-2"><button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'aroma', 'L√•g')">L√•g</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'aroma', 'Medel')">Medel</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'aroma', 'H√∂g')">H√∂g</button>
          </div>
         </div>
         <div><label class="block text-sm font-semibold accent-deep mb-2">Fyllighet</label>
          <div class="flex gap-2"><button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'fullness', 'L√§tt')">L√§tt</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'fullness', 'Medium')">Medium</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'fullness', 'Fyllig')">Fyllig</button>
          </div>
         </div>
         <div><label class="block text-sm font-semibold accent-deep mb-2">Syra</label>
          <div class="flex gap-2"><button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'acidity', 'L√•g')">L√•g</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'acidity', 'Medel')">Medel</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'acidity', 'H√∂g')">H√∂g</button>
          </div>
         </div>
         <div><label class="block text-sm font-semibold accent-deep mb-2">S√∂tma</label>
          <div class="flex gap-2"><button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'sweetness', 'Torr')">Torr</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'sweetness', 'Halvtorr')">Halvtorr</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'sweetness', 'S√∂t')">S√∂t</button>
          </div>
         </div>
         <div><label class="block text-sm font-semibold accent-deep mb-2">Betyg</label>
          <div id="star-container" class="flex justify-center gap-1"><button type="button" class="star-btn" onclick="setRating(1)">‚òÜ</button> <button type="button" class="star-btn" onclick="setRating(2)">‚òÜ</button> <button type="button" class="star-btn" onclick="setRating(3)">‚òÜ</button> <button type="button" class="star-btn" onclick="setRating(4)">‚òÜ</button> <button type="button" class="star-btn" onclick="setRating(5)">‚òÜ</button>
          </div>
         </div>
         <div><label class="block text-sm font-semibold accent-deep mb-2">K√∂pa igen?</label>
          <div class="flex gap-2"><button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'repurchase', 'Ja')">Ja</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'repurchase', 'Kanske')">Kanske</button> <button type="button" class="option-btn flex-1 rounded-lg" onclick="selectOption(this, 'repurchase', 'Nej')">Nej</button>
          </div>
         </div>
         <div><label class="block text-sm font-semibold accent-deep mb-2">Noteringar</label> <textarea id="notes" placeholder="Anteckningar..." class="w-full rounded-lg border border-gray-300"></textarea>
         </div>
        </div>
        <div class="flex gap-2 mt-6"><button type="submit" class="flex-1 btn-primary rounded-lg font-semibold transition-all"> ‚úì Spara </button> <button type="button" onclick="closeRatingModal()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold transition-all"> ‚úï St√§ng </button>
        </div>
       </form>
      </div>
     </div><!-- Wine Details Modal -->
     <div id="details-modal" class="hidden fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4">
      <div class="card-light rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-4xl max-h-[90vh] overflow-y-auto p-4 sm:p-8">
       <div class="flex justify-between items-start mb-4">
        <div>
         <h2 id="details-wine-title" class="font-display text-2xl font-bold accent-deep mb-1">Vin</h2>
         <p id="details-wine-info" class="text-gray-600 text-sm"></p>
        </div><button type="button" onclick="closeDetailsModal()" class="text-2xl">‚úï</button>
       </div>
       <div id="details-content" class="space-y-6"><!-- Wine details will be displayed here -->
       </div><button type="button" onclick="closeDetailsModal()" class="w-full btn-primary rounded-lg font-semibold transition-all mt-6"> ‚úï St√§ng </button>
      </div>
     </div>
    </div><!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-4 right-4 sm:left-auto sm:right-auto sm:bottom-4 sm:left-1/2 sm:-translate-x-1/2 px-6 py-3 bg-green-600 text-white rounded-full shadow-lg opacity-0 transition-all duration-300 pointer-events-none z-40">
     Sparad!
    </div>
   </div>
  </div>


  <!-- FIREBASE REALTIME LAYER (Firebase + dataSdk shim) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, setDoc, doc, deleteDoc, onSnapshot, query
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config (din web-app)
    const firebaseConfig = {
      apiKey: "AIzaSyAVEdU2uNKw9bm4FFdXdPPQvcO5vw6bkrM",
      authDomain: "vinprovning-3cd60.firebaseapp.com",
      projectId: "vinprovning-3cd60",
      storageBucket: "vinprovning-3cd60.firebasestorage.app",
      messagingSenderId: "408622400735",
      appId: "1:408622400735:web:6e04a1d0bb3ee7ddde556a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Anonymous auth (f√∂r att kunna l√§sa/skriva enligt vanliga rules)
    const auth = getAuth(app);
    try { await signInAnonymously(auth); } catch (e) { console.warn("Auth error:", e); }

    // Alla som √∂ppnar samma l√§nk med samma ?event= delar data
    const eventId = new URLSearchParams(location.search).get("event") || "slalomgrand";
    const itemsRef = collection(db, "events", eventId, "items");

    async function createItem(payload) {
      await addDoc(itemsRef, payload);
      return { isOk: true };
    }
    async function updateItem(existing, patch) {
      await setDoc(doc(itemsRef, existing.__backendId), { ...existing, ...patch }, { merge: true });
      return { isOk: true };
    }
    async function deleteItem(existing) {
      await deleteDoc(doc(itemsRef, existing.__backendId));
      return { isOk: true };
    }

    // ‚úÖ Shim: beh√•ll "window.dataSdk.*" s√• din befintliga Canva-kod funkar
    window.dataSdk = {
      init: async (handler) => {
        window.__legacyDataHandler = handler;
        return { isOk: true };
      },
      create: async (payload) => createItem(payload),
      update: async (payload) => updateItem(payload, payload),
      delete: async (payload) => deleteItem(payload),
    };

    // Realtime -> k√∂r din dataHandler.onDataChanged(data) n√§r n√•gon √§ndrar n√•got
    onSnapshot(query(itemsRef), (snap) => {
      const data = snap.docs.map(d => ({ __backendId: d.id, ...d.data() }));
      const h = window.__legacyDataHandler || window.dataHandler;
      if (h && typeof h.onDataChanged === "function") h.onDataChanged(data);
    });
  </script>


  <script>
    // -------------------------
    // QUIZFR√ÖGOR (1-15)
    // -------------------------
    const quizQuestions = [
      { id: 1, question: "Vilket land producerar mest vin i v√§rlden (totalt antal liter, ungef√§rligt snitt √•r)?", options: { "1": "Spanien", "X": "Italien", "2": "Frankrike" }, correct: "X" },
      { id: 2, question: "Vilken druva √§r huvuddruvan i r√∂tt vin fr√•n Barolo?", options: { "1": "Barbera", "X": "Sangiovese", "2": "Nebbiolo" }, correct: "2" },
      { id: 3, question: "Vad betyder 'Sec' p√• en fransk vinetikett?", options: { "1": "Torrt", "X": "Halvtorrt/halvs√∂tt", "2": "Mycket s√∂tt" }, correct: "X" },
      { id: 4, question: "Vilket vinomr√•de √§r mest k√§nt f√∂r druvan Riesling?", options: { "1": "Rioja", "X": "Bordeaux", "2": "Mosel" }, correct: "2" },
      { id: 5, question: "Vad h√§nder under malolaktisk j√§sning?", options: { "1": "Sockret omvandlas till alkohol", "X": "√Ñppelsyra omvandlas till mj√∂lksyra", "2": "Alkohol omvandlas till vin√§ger" }, correct: "X" },
      { id: 6, question: "Vilket land kommer druvan Malbec ursprungligen fr√•n?", options: { "1": "Argentina", "X": "Chile", "2": "Frankrike" }, correct: "2" },
      { id: 7, question: "Vad inneb√§r 'fatlagrat vin' oftast f√∂r smaken?", options: { "1": "Mer tannin, krydda och vaniljtoner", "X": "L√§gre alkoholhalt", "2": "Mindre syra" }, correct: "1" },
      { id: 8, question: "Cava produceras fr√§mst i‚Ä¶", options: { "1": "Italien", "X": "Spanien", "2": "Portugal" }, correct: "X" },
      { id: 9, question: "Vad √§r Prosecco gjord fr√§mst p√• f√∂r druva?", options: { "1": "Glera", "X": "Trebbiano", "2": "Pinot Grigio" }, correct: "1" },
      { id: 10, question: "Vilket klimat ger oftast viner med h√∂gre syra och l√§gre alkohol?", options: { "1": "Varmt klimat", "X": "Svalt klimat", "2": "Tropiskt klimat" }, correct: "X" },
      { id: 11, question: "Vad betyder 'Grand Cru' i Bourgogne?", options: { "1": "En speciell druva", "X": "En metod f√∂r lagring", "2": "Den h√∂gsta ving√•rdsklassificeringen" }, correct: "2" },
      { id: 12, question: "Vilken f√§rg f√•r vin av l√•ng skalkontakt med bl√• druvor?", options: { "1": "M√∂rkare f√§rg och mer tannin", "X": "Ljusare f√§rg", "2": "Ingen skillnad alls" }, correct: "1" },
      { id: 13, question: "Vad √§r typiskt f√∂r Sauvignon Blanc fr√•n Nya Zeeland?", options: { "1": "Sm√∂riga, ekiga toner", "X": "H√∂g syra och aromer av krusb√§r/citrus", "2": "Mycket tannin" }, correct: "X" },
      { id: 14, question: "Hur g√∂rs ros√©vin oftast?", options: { "1": "Man blandar r√∂tt och vitt vin", "X": "L√•ng lagring p√• ekfat", "2": "Kort skalkontakt med bl√• druvor" }, correct: "2" },
      { id: 15, question: "Vad betyder 'Reserva' i spanska Rioja (generellt)?", options: { "1": "H√∂gre lagringskrav √§n Crianza", "X": "Ekologiskt vin", "2": "L√•g alkoholhalt" }, correct: "1" }
    ];

    // -------------------------
    // STATE
    // -------------------------
    const defaultConfig = { event_title: 'Vinprovning p√• slalomgr√§nd', participant_count: '20' };

    let wines = [];
    let participants = [];
    let ratings = [];
    let quizResults = [];

    let currentRating = 0;
    let currentVoter = null;
    let currentWineId = null;

    let currentQuizParticipant = null;
    let currentQuestionIndex = 0;
    let quizAnswers = {};

    let ratingOptions = { aroma: null, fullness: null, acidity: null, sweetness: null, repurchase: null };
    let resetConfirming = false;

    // -------------------------
    // NAV / VIEWS
    // -------------------------
    function showSetup() {
      document.getElementById('setup-section').classList.remove('hidden');
      document.getElementById('voting-section').classList.add('hidden');
      document.getElementById('wine-results-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('quiz-results-section').classList.add('hidden');
      updateNavButtons();
    }

    function showVoting() {
      document.getElementById('setup-section').classList.add('hidden');
      document.getElementById('voting-section').classList.remove('hidden');
      document.getElementById('wine-results-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('quiz-results-section').classList.add('hidden');
      renderVotingWines();
      updateNavButtons();
    }

    function showWineResults() {
      document.getElementById('setup-section').classList.add('hidden');
      document.getElementById('voting-section').classList.add('hidden');
      document.getElementById('wine-results-section').classList.remove('hidden');
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('quiz-results-section').classList.add('hidden');
      renderWineResults();
      updateNavButtons();
    }

    function showQuiz() {
      document.getElementById('setup-section').classList.add('hidden');
      document.getElementById('voting-section').classList.add('hidden');
      document.getElementById('wine-results-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-results-section').classList.add('hidden');
      renderQuizStart();
      updateNavButtons();
    }

    function showQuizResults() {
      document.getElementById('setup-section').classList.add('hidden');
      document.getElementById('voting-section').classList.add('hidden');
      document.getElementById('wine-results-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('quiz-results-section').classList.remove('hidden');
      renderQuizResults();
      updateNavButtons();
    }

    function updateNavButtons() {
      const isSetup = !document.getElementById('setup-section').classList.contains('hidden');
      const isVoting = !document.getElementById('voting-section').classList.contains('hidden');
      const isWineResults = !document.getElementById('wine-results-section').classList.contains('hidden');
      const isQuiz = !document.getElementById('quiz-section').classList.contains('hidden');
      const isQuizResults = !document.getElementById('quiz-results-section').classList.contains('hidden');

      document.getElementById('btn-setup').classList.toggle('btn-primary', isSetup);
      document.getElementById('btn-setup').classList.toggle('bg-white/20', !isSetup);

      document.getElementById('btn-vote').classList.toggle('btn-primary', isVoting);
      document.getElementById('btn-vote').classList.toggle('bg-white/20', !isVoting);

      document.getElementById('btn-wine-results').classList.toggle('btn-primary', isWineResults);
      document.getElementById('btn-wine-results').classList.toggle('bg-white/20', !isWineResults);

      document.getElementById('btn-quiz').classList.toggle('btn-primary', isQuiz);
      document.getElementById('btn-quiz').classList.toggle('bg-white/20', !isQuiz);

      document.getElementById('btn-quiz-results').classList.toggle('btn-primary', isQuizResults);
      document.getElementById('btn-quiz-results').classList.toggle('bg-white/20', !isQuizResults);
    }

    // -------------------------
    // TOAST
    // -------------------------
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className =
        `fixed bottom-4 left-4 right-4 sm:left-auto sm:right-auto sm:bottom-4 sm:left-1/2 sm:-translate-x-1/2 px-6 py-3 ${
          type === 'error' ? 'bg-red-600' : 'bg-green-600'
        } text-white rounded-full shadow-lg transition-all duration-300 z-40`;
      toast.style.opacity = '1';
      setTimeout(() => { toast.style.opacity = '0'; }, 3000);
    }

    // -------------------------
    // SETUP: ADD WINE / PARTICIPANT
    // -------------------------
    async function handleAddWine(e) {
      e.preventDefault();

      const number = document.getElementById('wine_number').value.trim();
      if (!number) { showToast('Vinnummer √§r obligatoriskt', 'error'); return; }
      if (wines.find(w => w.wine_number === number)) { showToast('Vin nummer ' + number + ' finns redan', 'error'); return; }

      const wineData = {
        wine_id: 'wine_' + Date.now(),
        wine_number: number,
        country: document.getElementById('country').value,
        grape: document.getElementById('grape').value,
        price: document.getElementById('price').value,
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(wineData);
      if (result.isOk) {
        document.getElementById('wine-form').reset();
        showToast('Vin tillagt!');
      } else {
        showToast('Kunde inte l√§gga till vin', 'error');
      }
    }

    async function handleAddParticipant(e) {
      e.preventDefault();

      if (participants.length >= parseInt(defaultConfig.participant_count)) {
        showToast('Maximal antal deltagare n√•tt', 'error');
        return;
      }

      const name = document.getElementById('participant_name').value.trim();
      if (!name) { showToast('Namn √§r obligatoriskt', 'error'); return; }

      const participantData = {
        participant_id: 'participant_' + Date.now(),
        participant_name: name,
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(participantData);
      if (result.isOk) {
        document.getElementById('participant_name').value = '';
        showToast('Deltagare tillagd!');
      } else {
        showToast('Kunde inte l√§gga till deltagare', 'error');
      }
    }

    // -------------------------
    // RESET QUIZ
    // -------------------------
    function confirmResetQuiz() {
      const btn = document.getElementById('reset-quiz-btn');
      if (!resetConfirming) {
        resetConfirming = true;
        btn.textContent = '‚ùå Bekr√§fta f√∂r att ta bort';
        btn.classList.add('reset-confirm');
        setTimeout(() => {
          resetConfirming = false;
          btn.textContent = 'üîÑ √Öterst√§ll Quiz';
          btn.classList.remove('reset-confirm');
        }, 3000);
        return;
      }
      resetConfirming = false;
      btn.textContent = 'üîÑ √Öterst√§ll Quiz';
      btn.classList.remove('reset-confirm');
      resetQuiz();
    }

    async function resetQuiz() {
      const quizResultsToDelete = [...quizResults];
      for (const result of quizResultsToDelete) {
        const delResult = await window.dataSdk.delete(result);
        if (!delResult.isOk) { showToast('Kunde inte ta bort alla quizresultat', 'error'); return; }
      }
      showToast('Quiz √•terst√§llt!');
    }

    // -------------------------
    // VOTING
    // -------------------------
    function selectVoter() {
      const voterId = document.getElementById('voter-select').value;
      currentVoter = participants.find(p => p.participant_id === voterId) || null;
      renderVotingWines();
    }

    function renderVotingWines() {
      const container = document.getElementById('wines-voting');
      if (!currentVoter) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">V√§lj en deltagare f√∂rst</p>';
        return;
      }

      const sortedWines = [...wines].sort((a, b) => {
        const numA = parseInt(a.wine_number) || Infinity;
        const numB = parseInt(b.wine_number) || Infinity;
        if (numA === numB) return a.wine_number.localeCompare(b.wine_number);
        return numA - numB;
      });

      container.innerHTML = sortedWines.map(wine => {
        const hasRating = ratings.find(r => r.participant_id === currentVoter.participant_id && r.wine_id === wine.wine_id);
        return `
          <div class="wine-card bg-white rounded-lg p-3 ${hasRating ? 'active' : ''}" onclick="openRatingModal('${wine.wine_id}', '${wine.wine_number}')">
            <div class="flex justify-between items-center">
              <div>
                <h3 class="font-semibold accent-deep">Vin #${wine.wine_number}</h3>
                <p class="text-gray-600 text-sm">${wine.country} ‚Ä¢ ${wine.grape}</p>
              </div>
              <div class="text-2xl">
                ${hasRating ? '‚úì' : '‚Üí'}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // -------------------------
    // RATING MODAL
    // -------------------------
    function openRatingModal(wineId, wineNumber) {
      if (!currentVoter) return;

      currentWineId = wineId;
      const wine = wines.find(w => w.wine_id === wineId);

      document.getElementById('modal-wine-title').textContent = `Vin #${wineNumber}`;
      document.getElementById('modal-wine-info').textContent = `${wine.country} ‚Ä¢ ${wine.grape}${wine.price ? ' ‚Ä¢ ' + wine.price : ''}`;

      resetRatingForm();

      const existing = ratings.find(r => r.participant_id === currentVoter.participant_id && r.wine_id === wineId);
      if (existing) {
        ratingOptions.aroma = existing.aroma;
        ratingOptions.fullness = existing.fullness;
        ratingOptions.acidity = existing.acidity;
        ratingOptions.sweetness = existing.sweetness;
        ratingOptions.repurchase = existing.repurchase;
        currentRating = existing.rating;
        document.getElementById('notes').value = existing.notes || '';
        updateRatingUI();
      }

      document.getElementById('rating-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeRatingModal() {
      document.getElementById('rating-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      resetRatingForm();
    }

    function selectOption(btn, field, value) {
      const parent = btn.parentElement;
      parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      ratingOptions[field] = value;
    }

    function setRating(rating) {
      currentRating = rating;
      updateRatingUI();
    }

    function updateRatingUI() {
      // mark selected option buttons
      document.querySelectorAll('.option-btn').forEach(btn => {
        const parent = btn.parentElement;
        let fieldName = '';
        const labelText = parent.previousElementSibling?.textContent || '';
        if (labelText.includes('Aroma')) fieldName = 'aroma';
        else if (labelText.includes('Fyllighet')) fieldName = 'fullness';
        else if (labelText.includes('Syra')) fieldName = 'acidity';
        else if (labelText.includes('S√∂tma')) fieldName = 'sweetness';
        else if (labelText.includes('K√∂pa')) fieldName = 'repurchase';

        if (fieldName && btn.textContent === ratingOptions[fieldName]) btn.classList.add('selected');
        else btn.classList.remove('selected');
      });

      // stars
      document.querySelectorAll('.star-btn').forEach((btn, i) => {
        btn.textContent = i < currentRating ? '‚òÖ' : '‚òÜ';
        btn.classList.toggle('star-rating', i < currentRating);
      });
    }

    function resetRatingForm() {
      currentRating = 0;
      ratingOptions = { aroma: null, fullness: null, acidity: null, sweetness: null, repurchase: null };
      document.getElementById('notes').value = '';
      document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
      document.querySelectorAll('.star-btn').forEach(btn => { btn.textContent = '‚òÜ'; btn.classList.remove('star-rating'); });
    }

    async function handleSubmitRating(e) {
      e.preventDefault();

      if (!ratingOptions.aroma || !ratingOptions.fullness || !ratingOptions.acidity || !ratingOptions.sweetness || !ratingOptions.repurchase || currentRating === 0) {
        showToast('Fyll i alla f√§lt', 'error');
        return;
      }

      const existing = ratings.find(r => r.participant_id === currentVoter.participant_id && r.wine_id === currentWineId);

      const ratingData = {
        participant_id: currentVoter.participant_id,
        wine_id: currentWineId,
        aroma: ratingOptions.aroma,
        fullness: ratingOptions.fullness,
        acidity: ratingOptions.acidity,
        sweetness: ratingOptions.sweetness,
        rating: currentRating,
        repurchase: ratingOptions.repurchase,
        notes: document.getElementById('notes').value,
        created_at: new Date().toISOString()
      };

      let result;
      if (existing) result = await window.dataSdk.update({ ...existing, ...ratingData });
      else result = await window.dataSdk.create(ratingData);

      if (result.isOk) {
        showToast('Bed√∂mning sparad!');
        closeRatingModal();
        renderVotingWines();
      } else {
        showToast('Kunde inte spara bed√∂mning', 'error');
      }
    }

    // -------------------------
    // RESULTS (WINE)
    // -------------------------
    function renderWineResults() {
      const container = document.getElementById('wine-results-content');

      const validWines = wines.filter(w => w.wine_id && w.wine_number && w.country && w.grape);
      const validRatings = ratings.filter(r => validWines.some(w => w.wine_id === r.wine_id) && participants.some(p => p.participant_id === r.participant_id));

      if (validWines.length === 0 || validRatings.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-600 py-8">Ingen bed√∂mning √§nnu</p>';
        return;
      }

      const wineScores = validWines.map(wine => {
        const wineRatings = validRatings.filter(r => r.wine_id === wine.wine_id);
        const avgRating = wineRatings.length > 0 ? (wineRatings.reduce((sum, r) => sum + r.rating, 0) / wineRatings.length).toFixed(2) : 0;
        return { ...wine, avgRating: parseFloat(avgRating), ratingCount: wineRatings.length, ratings: wineRatings };
      }).sort((a, b) => b.avgRating - a.avgRating);

      let resultsHTML = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 items-end">';
      if (wineScores.length >= 3) {
        const displayOrder = [wineScores[1], wineScores[0], wineScores[2]];
        const heights = ['h-40', 'h-48', 'h-32'];
        const podiumClasses = ['podium-silver', 'podium-gold', 'podium-bronze'];
        const medals = ['ü•à', 'ü•á', 'ü•â'];
        const positions = [2, 1, 3];

        displayOrder.forEach((wine, displayIndex) => {
          resultsHTML += `
            <div class="flex flex-col items-center cursor-pointer" onclick="openDetailsModal('${wine.wine_id}', '${wine.wine_number}')">
              <div class="w-full text-center mb-4 min-h-24 flex items-center justify-center">
                <div>
                  <h3 class="font-display text-lg font-bold accent-deep">${medals[displayIndex]}</h3>
                  <h3 class="font-display text-lg font-bold accent-deep">Vin #${wine.wine_number}</h3>
                  <p class="text-gray-600 text-sm">${wine.country}</p>
                  <p class="font-bold text-2xl accent-deep mt-2">${wine.avgRating}</p>
                </div>
              </div>
              <div class="${heights[displayIndex]} ${podiumClasses[displayIndex]} w-full rounded-t-lg flex items-end justify-center pb-4">
                <p class="podium-position">${positions[displayIndex]}</p>
              </div>
            </div>
          `;
        });
      } else {
        wineScores.forEach((wine, index) => {
          const heights = ['h-48', 'h-40', 'h-32'];
          const podiumClasses = ['podium-gold', 'podium-silver', 'podium-bronze'];
          const medals = ['ü•á', 'ü•à', 'ü•â'];

          resultsHTML += `
            <div class="flex flex-col items-center cursor-pointer" onclick="openDetailsModal('${wine.wine_id}', '${wine.wine_number}')">
              <div class="w-full text-center mb-4 min-h-24 flex items-center justify-center">
                <div>
                  <h3 class="font-display text-lg font-bold accent-deep">${medals[index]}</h3>
                  <h3 class="font-display text-lg font-bold accent-deep">Vin #${wine.wine_number}</h3>
                  <p class="text-gray-600 text-sm">${wine.country}</p>
                  <p class="font-bold text-2xl accent-deep mt-2">${wine.avgRating}</p>
                </div>
              </div>
              <div class="${heights[index]} ${podiumClasses[index]} w-full rounded-t-lg flex items-end justify-center pb-4">
                <p class="podium-position">${index + 1}</p>
              </div>
            </div>
          `;
        });
      }
      resultsHTML += '</div>';

      if (wineScores.length > 3) {
        resultsHTML += '<div class="space-y-2">';
        wineScores.slice(3).forEach((wine, index) => {
          resultsHTML += `
            <div class="result-card rounded-lg p-4 border-2 border-gray-200 bg-white" onclick="openDetailsModal('${wine.wine_id}', '${wine.wine_number}')">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-display font-bold accent-deep">#${index + 4} Vin #${wine.wine_number}</h3>
                  <p class="text-gray-600 text-sm">${wine.country} ‚Ä¢ ${wine.grape}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold text-xl accent-deep">${wine.avgRating}</p>
                </div>
              </div>
            </div>
          `;
        });
        resultsHTML += '</div>';
      }

      container.innerHTML = resultsHTML;
    }

    // -------------------------
    // DETAILS MODAL
    // -------------------------
    function openDetailsModal(wineId, wineNumber) {
      const wine = wines.find(w => w.wine_id === wineId);
      const wineRatings = ratings.filter(r => r.wine_id === wineId);

      document.getElementById('details-wine-title').textContent = `Vin #${wineNumber}`;
      document.getElementById('details-wine-info').textContent = `${wine.country} ‚Ä¢ ${wine.grape}${wine.price ? ' ‚Ä¢ ' + wine.price : ''}`;

      const avgRating = wineRatings.length > 0 ? (wineRatings.reduce((sum, r) => sum + r.rating, 0) / wineRatings.length).toFixed(2) : 0;

      let detailsHTML = `
        <div class="bg-white rounded-lg p-4 mb-4">
          <div class="text-center mb-4">
            <div class="star-rating text-4xl mb-2">${'‚òÖ'.repeat(Math.round(avgRating))}${'‚òÜ'.repeat(5 - Math.round(avgRating))}</div>
            <p class="font-bold text-3xl accent-deep">${avgRating}</p>
            <p class="text-gray-600">${wineRatings.length} r√∂ster</p>
          </div>
        </div>
      `;

      if (wineRatings.length === 0) {
        detailsHTML += '<p class="text-center text-gray-500 py-8">Ingen bed√∂mning √§nnu</p>';
      } else {
        detailsHTML += `
          <div class="bg-white rounded-lg p-4 mb-4">
            <h3 class="font-semibold accent-deep mb-3">Karakteristika</h3>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-2">
              <div class="text-center"><p class="text-gray-600 text-xs font-medium">Aroma</p><p class="font-bold accent-deep text-sm mt-1">${getMostCommon(wineRatings.map(r => r.aroma))}</p></div>
              <div class="text-center"><p class="text-gray-600 text-xs font-medium">Fyllighet</p><p class="font-bold accent-deep text-sm mt-1">${getMostCommon(wineRatings.map(r => r.fullness))}</p></div>
              <div class="text-center"><p class="text-gray-600 text-xs font-medium">Syra</p><p class="font-bold accent-deep text-sm mt-1">${getMostCommon(wineRatings.map(r => r.acidity))}</p></div>
              <div class="text-center"><p class="text-gray-600 text-xs font-medium">S√∂tma</p><p class="font-bold accent-deep text-sm mt-1">${getMostCommon(wineRatings.map(r => r.sweetness))}</p></div>
              <div class="text-center"><p class="text-gray-600 text-xs font-medium">K√∂pa igen</p><p class="font-bold accent-deep text-sm mt-1">${getMostCommon(wineRatings.map(r => r.repurchase))}</p></div>
            </div>
          </div>
        `;

        detailsHTML += '<h3 class="font-semibold accent-deep mb-3 mt-4">Individuella bed√∂mningar</h3><div class="space-y-3">';
        wineRatings.forEach(rating => {
          const participant = participants.find(p => p.participant_id === rating.participant_id);
          detailsHTML += `
            <div class="bg-white rounded-lg p-3 border-l-4 border-accent-deep">
              <div class="flex justify-between items-start mb-2">
                <p class="font-semibold accent-deep">${participant ? participant.participant_name : 'Ok√§nd'}</p>
                <span class="star-rating text-lg">${'‚òÖ'.repeat(rating.rating)}${'‚òÜ'.repeat(5 - rating.rating)}</span>
              </div>
              <div class="grid grid-cols-2 gap-2 text-xs mb-2">
                <div><span class="text-gray-600">Aroma:</span> <span class="font-medium">${rating.aroma}</span></div>
                <div><span class="text-gray-600">Fyllighet:</span> <span class="font-medium">${rating.fullness}</span></div>
                <div><span class="text-gray-600">Syra:</span> <span class="font-medium">${rating.acidity}</span></div>
                <div><span class="text-gray-600">S√∂tma:</span> <span class="font-medium">${rating.sweetness}</span></div>
              </div>
              <div><span class="text-gray-600 text-xs">K√∂pa igen:</span> <span class="font-medium text-xs">${rating.repurchase}</span></div>
              ${rating.notes ? `<p class="text-gray-600 text-xs mt-2 italic">"${rating.notes}"</p>` : ''}
            </div>
          `;
        });
        detailsHTML += '</div>';
      }

      document.getElementById('details-content').innerHTML = detailsHTML;
      document.getElementById('details-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeDetailsModal() {
      document.getElementById('details-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function getMostCommon(arr) {
      if (arr.length === 0) return '-';
      const counts = {};
      arr.forEach(item => { counts[item] = (counts[item] || 0) + 1; });
      return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
    }

    // -------------------------
    // QUIZ
    // -------------------------
    function renderQuizStart() {
      const select = document.getElementById('quiz-participant-select');
      select.innerHTML = '<option value="">-- V√§lj ditt namn --</option>' +
        participants.sort((a, b) => a.participant_name.localeCompare(b.participant_name))
          .map(p => `<option value="${p.participant_id}">${p.participant_name}</option>`)
          .join('');
    }

    function startQuiz() {
      const participantId = document.getElementById('quiz-participant-select').value;
      if (!participantId) { showToast('V√§lj ditt namn f√∂rst', 'error'); return; }

      currentQuizParticipant = participants.find(p => p.participant_id === participantId);
      currentQuestionIndex = 0;
      quizAnswers = {};

      document.getElementById('quiz-participant-name').textContent = `Du svarar f√∂r: ${currentQuizParticipant.participant_name}`;
      document.getElementById('quiz-start-screen').classList.add('hidden');
      document.getElementById('quiz-questions-screen').classList.remove('hidden');
      renderQuizQuestion();
    }

    function renderQuizQuestion() {
      const question = quizQuestions[currentQuestionIndex];
      const container = document.getElementById('quiz-question-container');

      document.getElementById('quiz-question-number').textContent = `Fr√•ga ${currentQuestionIndex + 1} av ${quizQuestions.length}`;
      document.getElementById('quiz-progress-bar').style.width = (((currentQuestionIndex + 1) / quizQuestions.length) * 100) + '%';

      let html = `
        <div class="bg-white rounded-lg p-4">
          <h3 class="font-semibold accent-deep text-lg mb-4">${question.question}</h3>
          <div class="space-y-2">
      `;

      Object.entries(question.options).forEach(([key, value]) => {
        const isSelected = quizAnswers[question.id] === key;
        html += `
          <button type="button" class="quiz-option-btn w-full text-left rounded-lg ${isSelected ? 'selected' : ''}" onclick="selectQuizAnswer(${question.id}, '${key}')">
            <span class="font-semibold">${key}</span>: ${value}
          </button>
        `;
      });

      html += `</div></div>`;

      html += `
        <div class="flex gap-2 mt-6">
          ${currentQuestionIndex > 0 ? `<button type="button" onclick="previousQuestion()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">‚Üê F√∂reg√•ende</button>` : ''}
          <button type="button" onclick="nextQuestion()" class="flex-1 btn-primary rounded-lg font-semibold" ${!quizAnswers[question.id] ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
            ${currentQuestionIndex === quizQuestions.length - 1 ? 'Avsluta' : 'N√§sta'} ‚Üí
          </button>
        </div>
      `;

      container.innerHTML = html;
      updateQuizScore();
    }

    function selectQuizAnswer(questionId, answer) { quizAnswers[questionId] = answer; renderQuizQuestion(); }
    function previousQuestion() { if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuizQuestion(); } }

    function nextQuestion() {
      const question = quizQuestions[currentQuestionIndex];
      if (!quizAnswers[question.id]) { showToast('V√§lj ett svar f√∂rst', 'error'); return; }
      if (currentQuestionIndex < quizQuestions.length - 1) { currentQuestionIndex++; renderQuizQuestion(); }
      else { finishQuiz(); }
    }

    function updateQuizScore() {
      let score = 0;
      quizQuestions.forEach(q => { if (quizAnswers[q.id] === q.correct) score++; });
      document.getElementById('quiz-score').textContent = score;
    }

    function finishQuiz() {
      showToast('Quiz sparat! G√• till Topplista f√∂r att se resultat! üèÜ');
      saveQuizResult();
      goBackToQuizStart();
    }

    function goBackToQuizStart() {
      document.getElementById('quiz-start-screen').classList.remove('hidden');
      document.getElementById('quiz-questions-screen').classList.add('hidden');
      currentQuizParticipant = null;
      currentQuestionIndex = 0;
      quizAnswers = {};
    }

    async function saveQuizResult() {
      let score = 0;
      quizQuestions.forEach(q => { if (quizAnswers[q.id] === q.correct) score++; });

      const quizResultData = {
        quiz_result_id: 'quiz_' + Date.now(),
        quiz_participant_id: currentQuizParticipant.participant_id,
        quiz_participant_name: currentQuizParticipant.participant_name,
        quiz_score: score,
        quiz_answers: JSON.stringify(quizAnswers),
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(quizResultData);
      if (!result.isOk) showToast('Kunde inte spara quiz', 'error');
    }

    // -------------------------
    // QUIZ RESULTS + DETAILS
    // -------------------------
    function renderQuizResults() {
      const container = document.getElementById('quiz-results-content');
      const valid = quizResults.filter(r => participants.some(p => p.participant_id === r.quiz_participant_id));

      if (valid.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-600 py-8">Ingen quizresultat √§nnu</p>';
        return;
      }

      const sorted = [...valid].sort((a, b) => b.quiz_score - a.quiz_score);

      let resultsHTML = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 items-end">';
      const topN = Math.min(sorted.length, 3);
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const heights = ['h-48', 'h-40', 'h-32'];
      const podiumClasses = ['podium-gold', 'podium-silver', 'podium-bronze'];

      for (let i = 0; i < topN; i++) {
        const r = sorted[i];
        const percentage = Math.round((r.quiz_score / quizQuestions.length) * 100);
        resultsHTML += `
          <div class="flex flex-col items-center">
            <div class="w-full text-center mb-4 min-h-24 flex items-center justify-center">
              <div>
                <h3 class="font-display text-lg font-bold accent-deep">${medals[i]}</h3>
                <h3 class="font-display text-lg font-bold accent-deep">${r.quiz_participant_name}</h3>
                <p class="text-gray-600 text-sm">${percentage}% r√§tt</p>
                <p class="font-bold text-2xl accent-deep mt-2">${r.quiz_score}/${quizQuestions.length}</p>
              </div>
            </div>
            <div class="${heights[i]} ${podiumClasses[i]} w-full rounded-t-lg flex items-end justify-center pb-4">
              <p class="podium-position">${i + 1}</p>
            </div>
            <button class="w-full mt-2 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold accent-deep transition-all" onclick="showQuizDetails('${r.__backendId}', '${r.quiz_participant_name}', ${r.quiz_score})">
              Se fr√•gor och svar
            </button>
          </div>
        `;
      }
      resultsHTML += '</div>';

      if (sorted.length > 3) {
        resultsHTML += '<div class="space-y-2">';
        sorted.slice(3).forEach((r, idx) => {
          const percentage = Math.round((r.quiz_score / quizQuestions.length) * 100);
          resultsHTML += `
            <div class="result-card rounded-lg p-4 border-2 border-gray-200 bg-white">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-display font-bold accent-deep">#${idx + 4} ${r.quiz_participant_name}</h3>
                  <p class="text-gray-600 text-sm">${percentage}% r√§tt</p>
                </div>
                <div class="text-right">
                  <p class="font-bold text-xl accent-deep">${r.quiz_score}/${quizQuestions.length}</p>
                </div>
              </div>
              <button class="w-full mt-3 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-semibold accent-deep transition-all" onclick="showQuizDetails('${r.__backendId}', '${r.quiz_participant_name}', ${r.quiz_score})">
                Se fr√•gor och svar
              </button>
            </div>
          `;
        });
        resultsHTML += '</div>';
      }

      container.innerHTML = resultsHTML;
    }

    function showQuizDetails(backendId, participantName, score) {
      const quizResult = quizResults.find(r => r.__backendId === backendId);
      if (!quizResult) return;

      const answers = JSON.parse(quizResult.quiz_answers || '{}');
      let answersHTML = '';

      quizQuestions.forEach((question, idx) => {
        const userAnswer = answers[question.id];
        const isCorrect = userAnswer === question.correct;
        answersHTML += `
          <div class="bg-white rounded-lg p-4 border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}">
            <div class="flex items-start justify-between mb-2">
              <div>
                <p class="font-semibold accent-deep text-sm">Fr√•ga ${idx + 1}</p>
                <p class="text-sm text-gray-600 mt-1">${question.question}</p>
              </div>
              <div class="text-xl ml-2">${isCorrect ? '‚úì' : '‚úó'}</div>
            </div>
            <div class="mt-3 space-y-1">
              <p class="text-xs text-gray-600"><strong>Ditt svar:</strong> ${userAnswer ? question.options[userAnswer] : 'Inget svar'}</p>
              ${!isCorrect ? `<p class="text-xs text-gray-600"><strong>R√§tt svar:</strong> ${question.options[question.correct]}</p>` : ''}
            </div>
          </div>
        `;
      });

      document.getElementById('quiz-detail-title').textContent = `${participantName} - ${score}/${quizQuestions.length} r√§tt`;
      document.getElementById('quiz-detail-answers').innerHTML = answersHTML;
      document.getElementById('quiz-detail-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeQuizDetailModal() {
      document.getElementById('quiz-detail-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // -------------------------
    // LISTS (SETUP)
    // -------------------------
    function renderWinesList() {
      const container = document.getElementById('wines-list');
      const sortedWines = [...wines].sort((a, b) => {
        const numA = parseInt(a.wine_number) || Infinity;
        const numB = parseInt(b.wine_number) || Infinity;
        if (numA === numB) return a.wine_number.localeCompare(b.wine_number);
        return numA - numB;
      });

      container.innerHTML = sortedWines.map(wine => `
        <div class="bg-white rounded-lg p-3 flex justify-between items-center text-sm">
          <div>
            <h4 class="font-semibold accent-deep">Vin #${wine.wine_number}</h4>
            <p class="text-gray-600 text-xs">${wine.country} ‚Ä¢ ${wine.grape}</p>
          </div>
          <button onclick="deleteWine('${wine.__backendId}')" class="text-red-500 text-lg">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function renderParticipantsList() {
      const container = document.getElementById('participants-list');
      const sorted = [...participants].sort((a, b) => a.participant_name.localeCompare(b.participant_name));
      container.innerHTML = sorted.map(p => `
        <div class="bg-white rounded-lg p-2 flex justify-between items-center text-xs">
          <span class="font-medium accent-deep truncate">${p.participant_name}</span>
          <button onclick="deleteParticipant('${p.__backendId}')" class="text-red-500 ml-1 flex-shrink-0">‚úï</button>
        </div>
      `).join('');
    }

    let deleteConfirmId = null;

    async function deleteWine(id) {
      // 2-klick bekr√§ftelse
      if (deleteConfirmId !== id) {
        deleteConfirmId = id;
        const btn = event.target;
        btn.innerHTML = '‚ùå';
        setTimeout(() => {
          if (deleteConfirmId === id) { btn.innerHTML = 'üóëÔ∏è'; deleteConfirmId = null; }
        }, 3000);
        return;
      }
      const wine = wines.find(w => w.__backendId === id);
      if (!wine) return;

      const result = await window.dataSdk.delete(wine);
      deleteConfirmId = null;
      if (!result.isOk) showToast('Kunde inte ta bort vinet', 'error');
    }

    async function deleteParticipant(id) {
      const participant = participants.find(p => p.__backendId === id);
      if (!participant) return;

      const result = await window.dataSdk.delete(participant);
      if (!result.isOk) showToast('Kunde inte ta bort deltagaren', 'error');
    }

    // -------------------------
    // DATA HANDLER (realtime)
    // -------------------------
    window.dataHandler = {
      onDataChanged(data) {
        wines = data.filter(item => item.wine_id && String(item.wine_id).startsWith('wine_'));
        participants = data.filter(item => item.participant_id && String(item.participant_id).startsWith('participant_'));
        quizResults = data.filter(item => item.quiz_result_id && String(item.quiz_result_id).startsWith('quiz_'));

        ratings = data.filter(item => {
          const isRating = item.wine_id && String(item.wine_id).startsWith('wine_') && item.participant_id && String(item.participant_id).startsWith('participant_');
          if (!isRating) return false;
          const wineStillExists = wines.some(w => w.wine_id === item.wine_id);
          const participantStillExists = participants.some(p => p.participant_id === item.participant_id);
          return wineStillExists && participantStillExists;
        });

        // uppdatera dropdown f√∂r r√∂sta
        const select = document.getElementById('voter-select');
        const currentValue = select.value;
        select.innerHTML = '<option value="">-- V√§lj deltagare --</option>' +
          participants.sort((a, b) => a.participant_name.localeCompare(b.participant_name))
            .map(p => `<option value="${p.participant_id}">${p.participant_name}</option>`)
            .join('');
        select.value = currentValue;

        renderQuizStart();

        if (!document.getElementById('setup-section').classList.contains('hidden')) {
          renderWinesList();
          renderParticipantsList();
        }
        if (!document.getElementById('voting-section').classList.contains('hidden')) renderVotingWines();
        if (!document.getElementById('wine-results-section').classList.contains('hidden')) renderWineResults();
        if (!document.getElementById('quiz-results-section').classList.contains('hidden')) renderQuizResults();
      }
    };

    // -------------------------
    // INIT
    // -------------------------
    (async function init() {
      // dataSdk (Firebase shim) ‚Äì koppla din dataHandler
      if (window.dataSdk && window.dataHandler) {
        await window.dataSdk.init(window.dataHandler);
      }
      showSetup();
    })();
  </script>

</body>
</html>
